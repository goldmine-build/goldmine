package extract

import (
	"os"
	"path/filepath"
	"strings"

	"go.goldmine.build/go/skerr"
	"go.goldmine.build/go/util"
)

// Extract scans the "_bazel_testlogs" directory inside the workspaceDir, and extracts any
// screenshots taken by Puppeteer tests into targetDir, that is, the PNG files generated by
// running `sk_element_puppeteer_test` tests.
func Extract(workspaceDir, targetDir string) error {
	// Resolve the //_bazel_testlogs symlink. Necessary because filepath.Walk() ignores symlinks.
	bazelTestlogsDir, err := filepath.EvalSymlinks(filepath.Join(workspaceDir, "_bazel_testlogs"))
	if err != nil {
		return skerr.Wrap(err)
	}

	if err := filepath.Walk(bazelTestlogsDir, func(path string, info os.FileInfo, err error) error {
		if err != nil {
			return skerr.Wrap(err)
		}
		if strings.Contains(path, "/test.outputs/puppeteer-test-screenshots/") && strings.HasSuffix(path, ".png") {
			util.CopyFile(path, filepath.Join(targetDir, filepath.Base(path)))
		}
		return nil
	}); err != nil {
		return skerr.Wrap(err)
	}

	return nil
}
