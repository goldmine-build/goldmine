# Our healhcheck response.
#
# Will match all requests that don't include a server_name, which is
# something only the healthchecks do, both GFE and readinessProbe.
server {
    listen 80;
    return 200 'ok';
}

# Rules that are only redirects.
include redirects.conf

# Rules that are generated from skia.org.domain annotations in kubernetes
# service configs.
include services.conf

###############################################################
#### All servers in this section have non-simple routing. #####
###############################################################

#####   google3-roll.skia.org   ###########################
server {
    listen      80;
    server_name google3-roll.skia.org;

    # Enforce browser XSS protection
    add_header X-XSS-Protection "1; mode=block";
    # Disable content sniffing
    add_header X-Content-Type-Options nosniff;

    location /json/roll {
        proxy_pass http://google3-roll;
        proxy_set_header Host $host;
    }
    location / {
        return 301 https://skia-autoroll.corp.goog/r/google3-autoroll;
    }
}

#####   gold.skia.org   ###########################
server {
    listen      80;
    server_name gold.skia.org;

    location /img/ {
        proxy_pass http://gold-skia-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-skia-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   public-gold.skia.org   ###########################
server {
    listen      80;
    server_name public-gold.skia.org;

    location /img/ {
        proxy_pass http://gold-skia-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-skia-public-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   lottie-gold.skia.org   ###########################
server {
    listen      80;
    server_name lottie-gold.skia.org;

    location /img/ {
        proxy_pass http://gold-lottie-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-lottie-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   pdfium-gold.skia.org   ###########################
server {
    listen      80;
    server_name pdfium-gold.skia.org;

    location /img/ {
        proxy_pass http://gold-pdfium-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-pdfium-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   flutter-gold.skia.org   ###########################
server {
    listen      80;
    server_name flutter-gold.skia.org;


    location /json/hashes {
        proxy_pass http://gold-flutter-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /json/expectations/ {
        proxy_pass http://gold-flutter-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /img/ {
        proxy_pass http://gold-flutter-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-flutter-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   chrome-gpu-gold.skia.org   ###########################
server {
    listen      80;
    server_name chrome-gpu-gold.skia.org;


    location /json/hashes {
        proxy_pass http://gold-chrome-gpu-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /json/expectations/ {
        proxy_pass http://gold-chrome-gpu-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /img/ {
        proxy_pass http://gold-chrome-gpu-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-chrome-gpu-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}

#####   chrome-gold.skia.org   ###########################
server {
    listen      80;
    server_name chrome-gold.skia.org;


    location /json/hashes {
        proxy_pass http://gold-chrome-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /json/expectations/ {
        proxy_pass http://gold-chrome-baselineserver:8000;
        proxy_set_header Host $host;
    }

    location /img/ {
        proxy_pass http://gold-chrome-diffserver:8001;
        proxy_set_header Host $host;
    }
    location / {
        proxy_pass http://gold-chrome-skiacorrectness:8000;
        proxy_set_header Host $host;
    }
}
