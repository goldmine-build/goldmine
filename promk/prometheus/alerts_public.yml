# Alerts for things in the skia-public cluster only.
#
# If anything in this file starts to run in another cluster, such as
# skia-corp, then break it out into its own alerts_NNNN.yml file
# and include it in each prometheus-CLUSTER.yml file that is it running in.
groups:
  - name: general
    rules:
      # alert-to-pubsub liveness
      - alert: AlertToPubSubLiveness
        expr:
          (min(liveness_alert_to_pubsub_alive_s{skia_location=~".+"}) by
          (skia_location)) > 90
        labels:
          category: infra
          severity: critical
          owner: jcgregorio@google.com
        annotations:
          abbr: '{{ $labels.skia_location }}'
          description:
            'alert-to-pubsub for {{ $labels.skia_location }} has failed to send
            a healthz PubSub event in 90s.
            https://skia.googlesource.com/buildbot/%2B/main/am/PROD.md#alert_to_pubsub'

      # CT
      # TODO(rmistry): Add error rate alert once logmetrics is ported to skia-public.
      - alert: CTFEPendingTaskCount
        expr: num_pending_tasks{app="ctfe"} >= 10
        for: 5m
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          description:
            'There are a lot of CTFE pending tasks.
            https://skia.googlesource.com/buildbot/%2B/main/ct/PROD.md#ctfe_pending_tasks'

      - alert: CTFEPendingTaskNotRunning
        expr: oldest_pending_task_status{app="ctfe"} >= 2
        for: 5m
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          description:
            'A task has been waiting to be executed for a while and it has still
            not started.
            https://skia.googlesource.com/buildbot/%2B/main/ct/PROD.md#ctfe_pending_tasks'

      - alert: FlutterLicenseScriptFailure
        expr:
          flutter_license_script_failure{app="autoroll-be-skia-flutter-autoroll"}
          > 0
        for: 5m
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          description:
            'The License scripts in the Skia->Flutter roller have failed.
            https://console.cloud.google.com/logs/viewer?project={{
            $labels.project }}&resource=k8s_container%2Fcluster_name%2F{{
            $labels.cluster }}%2Fnamespace_name%2Fdefault%2Fcontainer_name%2F{{
            $labels.app }}
            https://skia.googlesource.com/buildbot/%2B/main/autoroll/PROD.md#flutter_license_script_failure'

      # skia-flutter-autoroll takes a long time to transition because its pre-upload
      # scripts run flutter's license script which can take around 40 minutes.
      - alert: AutoRollLastTransition
        expr:
          liveness_last_successful_autoroll_tick_s{roller="skia-flutter-autoroll"}
          > 50*60
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          abbr: 'skia-flutter-autoroll'
          description:
            'Autoroll on {{ $labels.app }} has failed to transition for more
            than 50 minutes.
            https://console.cloud.google.com/logs/viewer?project={{
            $labels.project }}&resource=k8s_container%2Fcluster_name%2F{{
            $labels.cluster }}%2Fnamespace_name%2Fdefault%2Fcontainer_name%2F{{
            $labels.app }}'

      # Datahopper

      - alert: FirestoreBackupTooOld
        expr:
          liveness_last_successful_firestore_backup_s{app="datahopper"}/60/60/24
          > 7
        labels:
          category: infra
          severity: critical
          owner: borenet@google.com
        annotations:
          description:
            'The most recent successful Firestore weekly backup was more than 7
            days ago.
            https://skia.googlesource.com/buildbot/%2B/main/datahopper/PROD.md#firestore_weekly_backup'

      # PubSub
      - alert: GCloudMetricsLiveness
        expr: liveness_last_successful_report_gcloud_metrics_s > 600
        labels:
          category: infra
          severity: critical
          owner: borenet@google.com
        annotations:
          abbr: '{{ $labels.app }}'
          description:
            'datahopper has failed to successfully ingest metrics from GCloud
            projects in the last 10 minutes. Check the logs for datahopper and
            look for errors.'

      - alert: PerfIngestionBehind
        expr:
          avg_over_time(pubsub_num_undelivered_messages{subscription_id=~"perf-ingestion-.*"}[5m])
          > 10000
        labels:
          category: infra
          severity: critical
          owner: jcgregorio@google.com
        annotations:
          abbr: '{{ $labels.subscription_id }}'
          description:
            'There are too many undelivered pubsub messages for {{
            $labels.subscription_id }}'

      - alert: TaskDriverLogIngestionBehind
        expr:
          pubsub_oldest_unacked_message_age_s{subscription_id="td_server_log_collector"}
          > 600
        labels:
          category: infra
          severity: critical
          owner: borenet@google.com
        annotations:
          abbr: '{{ $labels.subscription_id }}'
          description:
            'A pubsub message for {{ $labels.subscription_id }} has not been
            acknowledged in more than 10 minutes.'

      # G3 Canary
      - alert: G3CanaryInfraFailure
        expr: g3_canary_infra_failure > 0
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          abbr: '{{ $labels.exported_job }}'
          description:
            'The G3 canary is experiencing failures and may need to be
            restarted.
            https://skia.googlesource.com/skia/+doc/main/infra/bots/task_drivers/g3_canary/PROD.md#g3_canary_infra_failures'

      # Recreate SKPs
      - alert: RecreateSKPsBuildFailure
        expr: recreate_skps_build_failure > 0
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          abbr: '{{ $labels.exported_job }}'
          description:
            'The chromium build in the latest RecreateSKPs bot run failed. Find
            the failed run and investigate:
            https://status.skia.org/?filter=Search&repo=skia&search=RecreateSKPs'

      - alert: RecreateSKPsCreationFailure
        expr: recreate_skps_creation_failure > 0
        labels:
          category: infra
          severity: critical
          owner: rmistry@google.com
        annotations:
          abbr: '{{ $labels.exported_job }}'
          description:
            'The SKPs asset creation script in the latest RecreateSKPs bot run
            failed. Find the failed run and investigate:
            https://status.skia.org/?filter=Search&repo=skia&search=RecreateSKPs'
